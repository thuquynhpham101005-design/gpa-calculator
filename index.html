<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPA Calculator - T√≠nh GPA t·ª´ng k·ª≥ & t√≠ch lu·ªπ</title>

  <!-- SheetJS (xlsx) for Export Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --card2:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:rgba(148,163,184,.18);
      --accent:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1000px 600px at 20% 0%, rgba(34,197,94,.12), transparent 50%),
                  radial-gradient(900px 600px at 90% 10%, rgba(59,130,246,.10), transparent 45%),
                  var(--bg);
      color:var(--text);
    }
    .container{
      max-width:1180px;
      margin:0 auto;
      padding:28px 18px 60px;
    }
    header{
      display:flex;
      gap:16px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:18px;
    }
    h1{
      margin:0;
      font-size:24px;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }
    .top-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    button{
      border:0;
      cursor:pointer;
      border-radius:14px;
      padding:10px 14px;
      font-weight:600;
      font-size:13px;
      transition:.2s;
      display:inline-flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .btn{
      background:rgba(255,255,255,.08);
      color:var(--text);
      border:1px solid rgba(255,255,255,.10);
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.10)}
    .btn-primary{
      background:rgba(34,197,94,.16);
      border:1px solid rgba(34,197,94,.35);
      color:#d1fae5;
    }
    .btn-primary:hover{background:rgba(34,197,94,.22)}
    .btn-danger{
      background:rgba(239,68,68,.14);
      border:1px solid rgba(239,68,68,.35);
      color:#fee2e2;
    }
    .btn-danger:hover{background:rgba(239,68,68,.20)}
    .summary-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      margin:14px 0 18px;
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px 14px;
    }
    .metric-title{color:var(--muted); font-size:12px}
    .metric-value{font-size:22px; font-weight:800; margin-top:6px}
    .metric-note{color:var(--muted); font-size:12px; margin-top:4px}

    .semesters{
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .semester{
      background:linear-gradient(180deg, rgba(17,26,46,.9), rgba(15,23,42,.85));
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow);
    }
    .semester-head{
      padding:14px 14px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--line);
      flex-wrap:wrap;
    }
    .semester-title{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
    }
    input[type="text"], input[type="number"], select{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
      font-size:13px;
    }
    input::placeholder{color:rgba(148,163,184,.75)}
    .semester-name{
      width:220px;
      max-width:60vw;
      font-weight:700;
    }
    .table-wrap{overflow:auto}
    table{
      width:100%;
      border-collapse:collapse;
      min-width:980px;
    }
    th, td{
      padding:12px 10px;
      border-bottom:1px solid var(--line);
      text-align:left;
      font-size:13px;
      vertical-align:middle;
    }
    th{color:var(--muted); font-size:12px; font-weight:700}
    .col-actions{text-align:right}
    .row-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .mini{
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
    }
    .footer-sem{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      flex-wrap:wrap;
    }
    .sem-metrics{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
    }
    .sem-metrics b{color:var(--text)}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      font-size:12px;
      color:var(--text);
      user-select:none;
    }
    .pill input{transform:translateY(1px)}
    .hint{
      color:var(--muted);
      font-size:12px;
      margin-left:6px;
    }

    .toast{
      position:fixed;
      right:16px;
      bottom:16px;
      background:rgba(17,26,46,.95);
      border:1px solid rgba(255,255,255,.12);
      padding:12px 14px;
      border-radius:14px;
      box-shadow:var(--shadow);
      color:var(--text);
      font-size:13px;
      opacity:0;
      transform:translateY(10px);
      transition:.25s;
      pointer-events:none;
    }
    .toast.show{opacity:1; transform:translateY(0)}

    @media (max-width:820px){
      .summary-grid{grid-template-columns:1fr}
      table{min-width:900px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>üìö GPA Calculator</h1>
        <div class="sub">
          T√≠nh <b>GPA t·ª´ng k·ª≥</b> v√† <b>GPA t√≠ch lu·ªπ</b> (h·ªá 4) ‚Ä¢ Export Excel ‚Ä¢ L∆∞u LocalStorage
        </div>
      </div>
      <div class="top-actions">
        <button class="btn btn-primary" id="addSemesterBtn">‚ûï Th√™m k·ª≥</button>
        <button class="btn" id="exportExcelBtn">üìä Export Excel</button>
        <button class="btn" id="exportBtn">‚¨áÔ∏è Export JSON</button>
        <button class="btn" id="importBtn">‚¨ÜÔ∏è Import JSON</button>
        <button class="btn btn-danger" id="resetBtn">üóëÔ∏è Reset</button>
        <input type="file" id="importFile" accept="application/json" hidden />
      </div>
    </header>

    <section class="summary-grid">
      <div class="card">
        <div class="metric-title">GPA t√≠ch lu·ªπ (ch·ªâ m√¥n t√≠nh GPA)</div>
        <div class="metric-value" id="cumGpa">0.00</div>
        <div class="metric-note">Kh√¥ng t√≠nh c√°c m√¥n ‚ÄúKh√¥ng t√≠nh GPA‚Äù</div>
      </div>
      <div class="card">
        <div class="metric-title">T·ªïng t√≠n ch·ªâ t√≠ch lu·ªπ (t√≠nh GPA)</div>
        <div class="metric-value" id="cumCredits">0</div>
        <div class="metric-note">Ch·ªâ t√≠nh m√¥n ƒë∆∞·ª£c ƒë∆∞a v√†o GPA</div>
      </div>
      <div class="card">
        <div class="metric-title">T·ªïng s·ªë m√¥n</div>
        <div class="metric-value" id="totalCourses">0</div>
        <div class="metric-note">Bao g·ªìm c·∫£ m√¥n kh√¥ng t√≠nh GPA</div>
      </div>
    </section>

    <main class="semesters" id="semesters"></main>
  </div>

  <div class="toast" id="toast"></div>

<script>
/** =========================
 *  GPA Calculator - Single file
 *  Features:
 *  - Export Excel (.xlsx) using SheetJS
 *  - Retake / Exclude from GPA per course
 *  ========================= */

const STORAGE_KEY = "gpa_calculator_v2";

const GRADE_TO_4 = {
  "A": 4.0,
  "B+": 3.5,
  "B": 3.0,
  "C+": 2.5,
  "C": 2.0,
  "D+": 1.5,
  "D": 1.0,
  "F": 0.0
};

const GRADE_OPTIONS = Object.keys(GRADE_TO_4);

const $ = (sel) => document.querySelector(sel);
const semestersEl = $("#semesters");
const toastEl = $("#toast");

function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function showToast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(() => toastEl.classList.remove("show"), 1800);
}

function defaultCourse(){
  return {
    id: uid(),
    name: "",
    credits: 3,
    grade: "A",
    retake: false,   // h·ªçc l·∫°i
    exclude: false   // kh√¥ng t√≠nh GPA
  };
}

function defaultSemester(){
  return {
    id: uid(),
    name: "K·ª≥ m·ªõi",
    courses: [defaultCourse()]
  };
}

function loadData(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return { semesters: [defaultSemester()] };
    const data = JSON.parse(raw);
    if(!data?.semesters?.length) return { semesters: [defaultSemester()] };

    // sanitize
    data.semesters.forEach(s=>{
      s.id ||= uid();
      s.name ||= "K·ª≥";
      s.courses ||= [];
      if(s.courses.length === 0) s.courses.push(defaultCourse());
      s.courses.forEach(c=>{
        c.id ||= uid();
        c.name ||= "";
        c.credits = Number(c.credits ?? 0);
        c.grade ||= "A";
        if(!GRADE_TO_4.hasOwnProperty(c.grade)) c.grade = "A";
        c.retake = Boolean(c.retake);
        c.exclude = Boolean(c.exclude);
      });
    });
    return data;
  }catch(e){
    return { semesters: [defaultSemester()] };
  }
}

function saveData(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

let state = loadData();

/** ======= Calculations ======= */

function calcSemester(semester){
  let totalCreditsAll = 0;   // t·ªïng t√≠n ch·ªâ t·∫•t c·∫£ m√¥n
  let totalCreditsGpa = 0;   // t·ªïng t√≠n ch·ªâ t√≠nh GPA
  let totalPointsGpa = 0;    // t·ªïng ƒëi·ªÉm quy ƒë·ªïi * t√≠n ch·ªâ (ch·ªâ m√¥n t√≠nh GPA)

  semester.courses.forEach(c=>{
    const credits = Number(c.credits) || 0;
    const gpa4 = GRADE_TO_4[c.grade] ?? 0;

    totalCreditsAll += credits;

    // exclude kh·ªèi GPA
    if(c.exclude) return;

    totalCreditsGpa += credits;
    totalPointsGpa += gpa4 * credits;
  });

  const gpa = totalCreditsGpa > 0 ? (totalPointsGpa / totalCreditsGpa) : 0;
  return { totalCreditsAll, totalCreditsGpa, totalPointsGpa, gpa };
}

function calcCumulative(){
  let creditsGpa = 0;
  let pointsGpa = 0;
  let courses = 0;

  state.semesters.forEach(s=>{
    const r = calcSemester(s);
    creditsGpa += r.totalCreditsGpa;
    pointsGpa += r.totalPointsGpa;
    courses += s.courses.length;
  });

  const gpa = creditsGpa > 0 ? (pointsGpa / creditsGpa) : 0;
  return { creditsGpa, pointsGpa, gpa, courses };
}

/** ======= Render ======= */

function gradeSelectHTML(value){
  return `
    <select class="grade">
      ${GRADE_OPTIONS.map(g=>`<option value="${g}" ${g===value?"selected":""}>${g} (${GRADE_TO_4[g].toFixed(1)})</option>`).join("")}
    </select>
  `;
}

function render(){
  semestersEl.innerHTML = "";

  state.semesters.forEach((sem)=>{
    const semRes = calcSemester(sem);

    const semEl = document.createElement("section");
    semEl.className = "semester";
    semEl.dataset.semId = sem.id;

    semEl.innerHTML = `
      <div class="semester-head">
        <div class="semester-title">
          <input class="semester-name" type="text" value="${escapeHtml(sem.name)}" />
          <span class="badge">GPA k·ª≥: <b>${semRes.gpa.toFixed(2)}</b></span>
          <span class="badge">TC t√≠nh GPA: <b>${semRes.totalCreditsGpa}</b></span>
          <span class="badge">TC t·ªïng: <b>${semRes.totalCreditsAll}</b></span>
        </div>
        <div class="top-actions">
          <button class="btn btn-primary mini addCourse">‚ûï Th√™m m√¥n</button>
          <button class="btn btn-danger mini deleteSemester">üóëÔ∏è Xo√° k·ª≥</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:34%">T√™n m√¥n</th>
              <th style="width:10%">T√≠n ch·ªâ</th>
              <th style="width:14%">ƒêi·ªÉm ch·ªØ</th>
              <th style="width:10%">H·ªá 4</th>
              <th style="width:22%">Tu·ª≥ ch·ªçn</th>
              <th class="col-actions" style="width:10%">Xo√°</th>
            </tr>
          </thead>
          <tbody>
            ${sem.courses.map((c)=>{
              const gpa4 = GRADE_TO_4[c.grade] ?? 0;
              return `
                <tr data-course-id="${c.id}">
                  <td>
                    <input type="text" class="courseName" placeholder="VD: Marketing cƒÉn b·∫£n" value="${escapeHtml(c.name)}" />
                  </td>
                  <td>
                    <input type="number" class="credits" min="0" step="1" value="${Number(c.credits) || 0}" />
                  </td>
                  <td>${gradeSelectHTML(c.grade)}</td>
                  <td><span class="badge">${gpa4.toFixed(1)}</span></td>
                  <td>
                    <label class="pill">
                      <input type="checkbox" class="retake" ${c.retake ? "checked" : ""}/>
                      H·ªçc l·∫°i
                    </label>
                    <label class="pill" style="margin-left:8px">
                      <input type="checkbox" class="exclude" ${c.exclude ? "checked" : ""}/>
                      Kh√¥ng t√≠nh GPA
                    </label>
                    <span class="hint">${c.exclude ? "‚Üí M√¥n n√†y s·∫Ω b·ªã lo·∫°i kh·ªèi GPA" : ""}</span>
                  </td>
                  <td class="col-actions">
                    <div class="row-actions">
                      <button class="btn btn-danger mini deleteCourse">Xo√°</button>
                    </div>
                  </td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      </div>

      <div class="footer-sem">
        <div class="sem-metrics">
          <span>Œ£(ƒëi·ªÉm√óTC) (t√≠nh GPA): <b>${semRes.totalPointsGpa.toFixed(2)}</b></span>
          <span>GPA k·ª≥: <b>${semRes.gpa.toFixed(2)}</b></span>
        </div>
        <div>
          <button class="btn mini duplicateSemester">üìÑ Nh√¢n ƒë√¥i k·ª≥</button>
        </div>
      </div>
    `;

    semestersEl.appendChild(semEl);
  });

  const cum = calcCumulative();
  $("#cumGpa").textContent = cum.gpa.toFixed(2);
  $("#cumCredits").textContent = cum.creditsGpa;
  $("#totalCourses").textContent = cum.courses;

  bindEvents();
  saveData();
}

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** ======= Events ======= */

function bindEvents(){
  document.querySelectorAll(".semester").forEach(semEl=>{
    const semId = semEl.dataset.semId;
    const sem = state.semesters.find(s=>s.id===semId);

    semEl.querySelector(".semester-name").oninput = (e)=>{
      sem.name = e.target.value;
      saveData();
    };

    semEl.querySelector(".addCourse").onclick = ()=>{
      sem.courses.push(defaultCourse());
      showToast("ƒê√£ th√™m m√¥n");
      render();
    };

    semEl.querySelector(".deleteSemester").onclick = ()=>{
      if(state.semesters.length === 1){
        showToast("Ph·∫£i c√≥ √≠t nh·∫•t 1 k·ª≥");
        return;
      }
      if(!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° k·ª≥ n√†y?")) return;
      state.semesters = state.semesters.filter(s=>s.id!==semId);
      showToast("ƒê√£ xo√° k·ª≥");
      render();
    };

    semEl.querySelector(".duplicateSemester").onclick = ()=>{
      const clone = JSON.parse(JSON.stringify(sem));
      clone.id = uid();
      clone.name = sem.name + " (copy)";
      clone.courses.forEach(c=> c.id = uid());
      state.semesters.splice(state.semesters.indexOf(sem)+1, 0, clone);
      showToast("ƒê√£ nh√¢n ƒë√¥i k·ª≥");
      render();
    };

    semEl.querySelectorAll("tbody tr").forEach(row=>{
      const courseId = row.dataset.courseId;
      const course = sem.courses.find(c=>c.id===courseId);

      row.querySelector(".courseName").oninput = (e)=>{
        course.name = e.target.value;
        saveData();
      };

      row.querySelector(".credits").oninput = (e)=>{
        const v = Number(e.target.value);
        course.credits = isNaN(v) ? 0 : Math.max(0, Math.floor(v));
        render();
      };

      row.querySelector(".grade").onchange = (e)=>{
        course.grade = e.target.value;
        render();
      };

      row.querySelector(".retake").onchange = (e)=>{
        course.retake = e.target.checked;
        saveData();
        showToast(course.retake ? "ƒê√£ b·∫≠t H·ªçc l·∫°i" : "ƒê√£ t·∫Øt H·ªçc l·∫°i");
      };

      row.querySelector(".exclude").onchange = (e)=>{
        course.exclude = e.target.checked;
        render();
      };

      row.querySelector(".deleteCourse").onclick = ()=>{
        if(sem.courses.length === 1){
          showToast("M·ªói k·ª≥ ph·∫£i c√≥ √≠t nh·∫•t 1 m√¥n");
          return;
        }
        sem.courses = sem.courses.filter(c=>c.id!==courseId);
        showToast("ƒê√£ xo√° m√¥n");
        render();
      };
    });
  });
}

/** ======= Export Excel ======= */

function exportExcel(){
  if(typeof XLSX === "undefined"){
    alert("Kh√¥ng load ƒë∆∞·ª£c th∆∞ vi·ªán XLSX. Ki·ªÉm tra m·∫°ng ho·∫∑c CDN.");
    return;
  }

  const rows = [];
  rows.push([
    "K·ª≥",
    "T√™n m√¥n",
    "T√≠n ch·ªâ",
    "ƒêi·ªÉm ch·ªØ",
    "H·ªá 4",
    "H·ªçc l·∫°i",
    "Kh√¥ng t√≠nh GPA",
    "T√≠nh v√†o GPA?"
  ]);

  state.semesters.forEach(sem=>{
    sem.courses.forEach(c=>{
      const gpa4 = GRADE_TO_4[c.grade] ?? 0;
      rows.push([
        sem.name,
        c.name,
        Number(c.credits) || 0,
        c.grade,
        gpa4,
        c.retake ? "C√≥" : "Kh√¥ng",
        c.exclude ? "C√≥" : "Kh√¥ng",
        c.exclude ? "Kh√¥ng" : "C√≥"
      ]);
    });

    const r = calcSemester(sem);
    rows.push(["", "", "", "", "", "", "", ""]);
    rows.push(["T·ªîNG K·∫æT K·ª≤", sem.name, "", "", "", "", "", ""]);
    rows.push(["GPA k·ª≥", r.gpa.toFixed(2), "TC t√≠nh GPA", r.totalCreditsGpa, "TC t·ªïng", r.totalCreditsAll, "", ""]);
    rows.push(["", "", "", "", "", "", "", ""]);
  });

  const cum = calcCumulative();
  rows.push(["T·ªîNG K·∫æT T√çCH LU·ª∏", "", "", "", "", "", "", ""]);
  rows.push(["GPA t√≠ch lu·ªπ", cum.gpa.toFixed(2), "T·ªïng TC t√≠nh GPA", cum.creditsGpa, "T·ªïng m√¥n", cum.courses, "", ""]);

  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "GPA");

  XLSX.writeFile(wb, "GPA_Calculator.xlsx");
  showToast("ƒê√£ xu·∫•t Excel");
}

/** ======= Top buttons ======= */

$("#addSemesterBtn").onclick = ()=>{
  state.semesters.push(defaultSemester());
  showToast("ƒê√£ th√™m k·ª≥");
  render();
};

$("#resetBtn").onclick = ()=>{
  if(!confirm("Reset to√†n b·ªô d·ªØ li·ªáu?")) return;
  localStorage.removeItem(STORAGE_KEY);
  state = { semesters: [defaultSemester()] };
  showToast("ƒê√£ reset");
  render();
};

$("#exportBtn").onclick = ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "gpa-data.json";
  a.click();
  URL.revokeObjectURL(url);
  showToast("ƒê√£ export JSON");
};

$("#exportExcelBtn").onclick = exportExcel;

$("#importBtn").onclick = ()=>{
  $("#importFile").click();
};

$("#importFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const text = await file.text();
    const imported = JSON.parse(text);
    if(!imported?.semesters) throw new Error("Invalid file");
    state = imported;
    showToast("Import th√†nh c√¥ng");
    render();
  }catch(err){
    alert("File JSON kh√¥ng h·ª£p l·ªá!");
  }finally{
    e.target.value = "";
  }
});

/** ======= Init ======= */
render();
</script>
</body>
</html>
